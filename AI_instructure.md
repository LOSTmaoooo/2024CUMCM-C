# 代码构建逻辑分析

## 代码目录
- **data_structure** ：数据处理模块，读取文件，清洗数据（除去缺失值、标题、备注），生成矩阵，并且提供矩阵与向量之间的转换函数,（用于适配神经网络输入输出）。
- **object_function** ：定义目标函数，计算奖励与惩罚，设置约束。
- **env_new** ：定义观测空间和动作空间，提供环境初始化，动作执行，观测获取，奖励计算的函数。
- **models** ：引入transformer自注意力模块，并使其参与模型神经网络连接层的搭建（多一层）。
- **train** ：构造sumtree的经验回放池，定义DQN模型的各种参数，定义act，remember，replay（update），save，load，train函数，并调用train函数进行训练。
- **eval** ：（待补充）

## 代码构建逻辑

### 代码文件顺序
excel > data_structure（处理成多个符合输入要求的矩阵格式） > object_function（读取数据后计算reward） > env_new > models > train > eval

### 类内方法逻辑关系
- **data_structure** ：（待补充）
- **object_function** ：
- **env_new** ：
- **models** ：
- **train** ：
- **eval** ：（待补充）

# 工作流程
以下是一个针对你需求的详细复刻AI代码的规划大纲，按照工程阶段划分任务，并包含相应的检验环节，重点解决数据处理中只有Excel文件而无CSV文件的问题：

### 一、前期准备阶段
#### 任务1：环境搭建
- **具体操作**：安装Python环境（建议使用Python 3.7及以上版本），安装项目所需的库，如`pandas`、`numpy`、`torch`、`gym`、`tqdm`、`matplotlib`、`joblib`等。可以使用`pip install`命令进行安装，例如`pip install pandas`。
- **检验方式**：在Python交互式环境中导入这些库，没有报错则说明安装成功。例如运行`import pandas`、`import numpy`等语句。

#### 任务2：熟悉代码结构和功能
- **具体操作**：仔细阅读之前分析的代码文件作用、引用关系以及各文件使用的库和功能等内容，梳理整个项目的逻辑。对每个文件在项目中的角色和目的有清晰的认识。
- **检验方式**：能够用自己的语言简要描述每个代码文件的主要功能和它们之间的协作关系，向他人讲解或形成文字记录。

### 二、数据处理阶段
#### 任务3：数据读取与转换
- **具体操作**：由于只有Excel文件，修改`data_structure.py`中读取数据的部分。将`pd.read_csv`相关代码删除，统一使用`pd.read_excel`来读取所有数据。例如，原代码中读取产量数据的`yield_data = pd.read_csv('/path/to/yield.csv')`修改为`yield_data = pd.read_excel('/mnt/附件1.xlsx')`（假设产量数据在附件1中，根据实际情况调整）。对于不同表中的数据，可以通过指定`sheet_name`参数来获取，如`yield_data = pd.read_excel('/mnt/附件1.xlsx', sheet_name='产量表')`。
- **检验方式**：打印读取的数据，检查数据的基本信息（`print(data.info())`）和前几行（`print(data.head())`），确保数据读取正确，字段和预期一致。

#### 任务4：数据清洗与整理
- **具体操作**：使用`pandas`的方法对读取的数据进行清洗，如删除缺失值（`dropna()`）、过滤无效行（使用`str.contains`等方法）。按照原代码逻辑构建地块 - 作物 - 年份的三维矩阵（如产量矩阵、价格矩阵），并实现矩阵与向量的相互转换方法。
- **检验方式**：检查清洗后的数据是否符合预期，没有缺失值和无效数据。通过打印矩阵和转换后的向量，验证转换方法是否正确工作，矩阵和向量之间的转换是否可逆。

### 三、代码适配与修改阶段
#### 任务5：路径修改
- **具体操作**：在所有涉及文件路径的代码中，将路径修改为你实际的文件路径。例如，在`data_structure.py`、`env_new.py`等文件中，把文件读取和保存的路径都修改为以`/mnt/`开头的路径。
- **检验方式**：运行代码，确保在读取和保存文件时不会出现路径错误的提示。如果代码报错，检查路径是否正确设置。

#### 任务6：代码兼容性检查与调整
- **具体操作**：由于数据处理方式的改变和路径的调整，可能会影响到其他代码文件的运行。仔细检查代码的逻辑，确保各文件之间的调用和数据传递仍然正确。对于可能出现的类型不匹配、维度不一致等问题进行调整。
- **检验方式**：对每个代码文件进行单元测试，例如编写简单的测试函数，调用`env_new.py`中的`step`和`reset`方法，检查是否能正常返回结果；调用`models.py`中的网络模型，检查前向传播是否能顺利进行。

### 四、模型训练与评估阶段
#### 任务7：模型训练
- **具体操作**：运行`train.py`文件开始训练模型。可以根据实际情况调整训练的超参数，如学习率、训练回合数等。在训练过程中，观察`matplotlib`绘制的奖励和损失曲线，了解模型的训练情况。
- **检验方式**：检查训练过程是否正常进行，没有报错。观察奖励曲线是否呈现上升趋势，损失曲线是否逐渐收敛。如果奖励不上升或损失不收敛，可能需要调整超参数或检查模型结构。

#### 任务8：模型评估
- **具体操作**：训练完成后，运行`eval.py`文件对模型进行评估。记录最优动作（最大奖励对应的种植策略）并保存。
- **检验方式**：检查评估结果是否合理，保存的最优动作文件是否存在且内容符合预期。可以尝试对评估结果进行简单的分析，如查看种植策略是否符合实际的农业逻辑。

### 五、总结与优化阶段
#### 任务9：总结与分析
- **具体操作**：回顾整个复刻过程，总结遇到的问题和解决方案。分析模型的训练和评估结果，思考模型的优缺点以及可以改进的地方。
- **检验方式**：形成一份详细的总结报告，包括复刻过程、问题解决记录、模型性能分析以及改进建议。

#### 任务10：优化与改进
- **具体操作**：根据总结分析的结果，对代码和模型进行优化。可以尝试不同的数据处理方法、调整模型结构或超参数，再次进行训练和评估，对比优化前后的效果。
- **检验方式**：比较优化前后模型的性能指标，如奖励值的提升、损失的降低等。如果性能有明显提升，则说明优化措施有效。 